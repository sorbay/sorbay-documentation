
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://doc.sorbay.com/sorbay_risk_integration/" rel="canonical"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-8.5.10" name="generator"/>
<title>Integration - sorbay documentation</title>
<link href="../assets/stylesheets/main.472b142f.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.08040f6c.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../assets/stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="None" data-md-color-primary="None" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#integration-of-a-sorbay_risk-service">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="sorbay documentation" class="md-header__button md-logo" data-md-component="logo" href=".." title="sorbay documentation">
<img alt="logo" src="../assets/images/sorbay-blue-white.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            sorbay documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Integration
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="sorbay documentation" class="md-nav__button md-logo" data-md-component="logo" href=".." title="sorbay documentation">
<img alt="logo" src="../assets/images/sorbay-blue-white.png"/>
</a>
    sorbay documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        Welcome
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../profile/">
        Profile
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../workspaces/">
        Workspaces
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4">
          Services
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Services" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Services
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../services/">
        About
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2">
          sorbay_ciam
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="sorbay_ciam" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
          sorbay_ciam
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../sorbay_ciam/">
        Configuration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sorbay_ciam_integration/">
        Integration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sorbay_ciam_api/">
        API
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3">
          sorbay_risk
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="sorbay_risk" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
          sorbay_risk
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../sorbay_risk/">
        Configuration
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Integration
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Integration
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-the-sorbay_risk-service">
    Configure the sorbay_risk service
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-your-login-service">
    Configure your login service
  </a>
<nav aria-label="Configure your login service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-get-login-page">
    1. ðŸ š GET login page
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-login-page-with-initial-js-and-nonce">
    2. ðŸ ˜ Login page (with initial js and nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-get-js-for-fingerprint-etc">
    3. ðŸ š GET js for fingerprint etc.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-js-for-fingerprint-etc">
    4. ðŸ ˜ js for fingerprint etc.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-rest-call-resttoken-client-fingerprint-nonce">
    5. ðŸ š REST call /rest/token (client fingerprint + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-token-opaque">
    6. ðŸ ˜ token (opaque)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-login-post-userid-password-token">
    7. ðŸ š Login POST (userid + password + token)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-rest-call-restrisk-userid-token-nonce">
    8. ðŸ š REST call /rest/risk (userid + token + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-risk-score">
    9. ðŸ ˜ risk score
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-login-ok-or-require-further-authentication">
    10. ðŸ ˜ login ok or require further authentication
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-opt-further-authentication">
    11. (opt. further authentication)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-rest-call-restloginok-userid-token-nonce">
    12. ðŸ š REST call /rest/loginok (userid + token + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-ok">
    13. ðŸ ˜ ok
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sorbay_risk_api/">
        API
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../members/">
        Members
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../settings/">
        Settings
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../help/">
        Help
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-the-sorbay_risk-service">
    Configure the sorbay_risk service
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configure-your-login-service">
    Configure your login service
  </a>
<nav aria-label="Configure your login service" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-get-login-page">
    1. ðŸ š GET login page
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-login-page-with-initial-js-and-nonce">
    2. ðŸ ˜ Login page (with initial js and nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-get-js-for-fingerprint-etc">
    3. ðŸ š GET js for fingerprint etc.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-js-for-fingerprint-etc">
    4. ðŸ ˜ js for fingerprint etc.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-rest-call-resttoken-client-fingerprint-nonce">
    5. ðŸ š REST call /rest/token (client fingerprint + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-token-opaque">
    6. ðŸ ˜ token (opaque)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-login-post-userid-password-token">
    7. ðŸ š Login POST (userid + password + token)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-rest-call-restrisk-userid-token-nonce">
    8. ðŸ š REST call /rest/risk (userid + token + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-risk-score">
    9. ðŸ ˜ risk score
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-login-ok-or-require-further-authentication">
    10. ðŸ ˜ login ok or require further authentication
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-opt-further-authentication">
    11. (opt. further authentication)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-rest-call-restloginok-userid-token-nonce">
    12. ðŸ š REST call /rest/loginok (userid + token + nonce)
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-ok">
    13. ðŸ ˜ ok
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="integration-of-a-sorbay_risk-service">Integration of a sorbay_risk service</h1>
<p>This guide will show you how to integrate your login service with the sorbay_risk service.</p>
<p>Let's assume that you have already created a sorbay_risk service.</p>
<h2 id="configure-the-sorbay_risk-service">Configure the sorbay_risk service</h2>
<p>Navigate to the "Settings" of your service, then go to the "Configuration" tab.</p>
<p>Configure at least one API key.
It will be needed in your login service for REST calls to the sorbay_risk service.</p>
<h2 id="configure-your-login-service">Configure your login service</h2>
<p>For simplicity, let's assume that your login service provides users who want to log in
with a simple login form with userid and password fields, plus has a hidden "token" field:</p>
<ul>
<li><strong>userid</strong>: Text field</li>
<li><strong>password</strong>: Password field</li>
<li><strong>token</strong>: Hidden field</li>
</ul>
<p>That might of course be different in practice, but what is crucial is that there should be a means to at least weakly authenticate a user (more precisely the userid) before using the sorbay_risk service.</p>
<p><span style="color:red"><strong><em>TODO</em></strong></span> Where would the base URL be obtained from?<br/>
=&gt; could be shown in the service GUI (selectable to copy and/or button to copy to clipboard)<br/>
=&gt; if so, would need to add documentation for that additional field</p>
<p>The base URL of the sorbay_risk service depends on the service name, let's assume the base URL is <code>https://risk.sorbay.com/myriskservice</code> below.</p>
<p>Here is the typical flow of requests and responses in case of a successful login:</p>
<pre class="mermaid"><code>sequenceDiagram

autonumber

actor client as client/browser
participant login as your login service
participant risk as sorbay_risk service

client -&gt;&gt; login: GET login page
login --&gt;&gt; client: login page&lt;br&gt;(with initial js and nonce)
client -&gt;&gt; risk: GET js for fingerprint etc.
risk --&gt;&gt; client: js for fingerprint etc.
client -&gt;&gt; risk: REST call /rest/token&lt;br&gt;(client fingerprint + nonce)
risk --&gt;&gt; client: token (opaque)
client -&gt;&gt; login: Login POST&lt;br&gt;(userid + password + token)
login -&gt;&gt; risk: REST call /rest/risk&lt;br&gt;(userid + token + nonce)
risk --&gt;&gt; login: risk score
login --&gt;&gt; client : login ok or require&lt;br&gt;further authentication
login --&gt; client : (opt. further authentication)
login -&gt;&gt; risk: REST call /rest/loginok&lt;br&gt;(userid + token + nonce)
risk --&gt;&gt; login: ok</code></pre>
<h4 id="1-get-login-page">1. ðŸ š GET login page</h4>
<p>A user goes to the login location in their browser/client
(directly or redirected when trying to access a protected application).</p>
<h4 id="2-login-page-with-initial-js-and-nonce">2. ðŸ ˜ Login page (with initial js and nonce)</h4>
<p>Your login service sends back a login page with form fields for <strong>userid</strong> and <strong>password</strong>,
plus a hidden field named <strong>token</strong>, and the following JavaScript:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">sorbayGetSetToken</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'https://risk.sorbay.com/myriskservice'</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">nonce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"603276204091730547274816"</span><span class="p">;</span>
<span class="w">    </span><span class="k">import</span><span class="p">(</span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'/resources/sorbay-risk.min.js'</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">'client-error: import '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'/resources/sorbay-risk.min.js failed: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span><span class="w"> </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">js</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">js</span><span class="p">.</span><span class="nx">sorbayGetToken</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">))</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'client-error: '</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">'client-error: sorbayGetToken() failed: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">token</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'setting token in form to: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">token</span><span class="p">);</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'token'</span><span class="p">).</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">sorbayGetSetToken</span><span class="p">();</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</code></pre></div>
<p><strong>IMPORTANT</strong>: The <strong>nonce</strong> value must be generated as a hard-to-guess random string by the login service on the <em>server side</em> (<strong><em>not</em></strong> on the browser/client) and must be remembered on the server during the login.
The nonce is later used to prevent some attacks.</p>
<h4 id="3-get-js-for-fingerprint-etc">3. ðŸ š GET js for fingerprint etc.</h4>
<p>The above JavaScript is run immediately (while the user is free to enter username and password in parallel). It fetches further JavaScript from the sorbay_risk service in order to calculate a browser/client fingerprint.</p>
<h4 id="4-js-for-fingerprint-etc">4. ðŸ ˜ js for fingerprint etc.</h4>
<p>The received JavaScript also runs immediately.</p>
<h4 id="5-rest-call-resttoken-client-fingerprint-nonce">5. ðŸ š REST call /rest/token (client fingerprint + nonce)</h4>
<p>The JavaScript determines the browser/client fingerprint and makes a rest call to the sorbay_risk service at <code>https://risk.sorbay.com/myriskservice/rest/token</code>, passing both <strong>fingerprint</strong> and <strong>nonce</strong>.</p>
<p>(Note that the API key is not used in that callout; usage of the API key is restricted to your login service, the API key should never be given/passed to the client.)</p>
<h4 id="6-token-opaque">6. ðŸ ˜ token (opaque)</h4>
<p>The sorbay_risk service returns the <strong>token</strong>, which is just an opaque string to the client. It contains in encrypted and signed form all collected attributes (IP, User-Agent, fingerprint, plus derived attributes like country, etc.) and the nonce for later comparison. It also contains a validity period and a unique id to further prevent replay attacks.</p>
<p>In the JavaScript above, the token is written to the hidden <strong>token</strong> field.</p>
<h4 id="7-login-post-userid-password-token">7. ðŸ š Login POST (userid + password + token)</h4>
<p>The user enters userid and password and submits them, posting them to your login service along with the token.</p>
<p>(Detail: Ideally, the submit button would only become active once the token had been obtained.)</p>
<h4 id="8-rest-call-restrisk-userid-token-nonce">8. ðŸ š REST call /rest/risk (userid + token + nonce)</h4>
<p>The login service validates userid/password and, if correct, makes a REST call to the <code>https://risk.sorbay.com/myriskservice/rest/risk</code> location on the sorbay_risk service, passing <strong>userid</strong>, <strong>nonce</strong> and <strong>token</strong>, plus the <strong>API key</strong> as <code>X-API-Key</code> HTTP request header.</p>
<h4 id="9-risk-score">9. ðŸ ˜ risk score</h4>
<p>The sorbay_risk service makes various validations, including:</p>
<ul>
<li>The API key must be equal to one of the configured API keys.</li>
<li>It can decipher the token and validate its signature.</li>
<li>The token must not have expired.</li>
<li>The nonce in the token must be equal to the directly posted nonce.</li>
</ul>
<p>If all validations pass, the sorbay_risk service calculates the risk score and returns it.</p>
<p>Your login service receives the risk score and is free what to do based on its value.</p>
<p>For example, if the risk score is lower than 0.4, a second factor authentication (SMS, etc.) could be skipped. Or if the risk score is above a certain value, an email could be sent to the user to inform of the login attempt "from a new location".</p>
<p>(The general recommendation is to first operate in mode where the risk score is calculated and logged, but no decisions are made based on it. After gaining some experience with how the risk score behaves in your specific setup and with your specific classes of users and their habits, start implementing different behavior depending on the risk score and maybe other attributes related to the user.)</p>
<h4 id="10-login-ok-or-require-further-authentication">10. ðŸ ˜ login ok or require further authentication</h4>
<p>You login service logs in the user if the risk score was deemed low enough, otherwise initiates further authentication.</p>
<h4 id="11-opt-further-authentication">11. (opt. further authentication)</h4>
<p>Optionally further authentication steps between client and your login service.</p>
<h4 id="12-rest-call-restloginok-userid-token-nonce">12. ðŸ š REST call /rest/loginok (userid + token + nonce)</h4>
<p>Whenever your login service decides that login with that user was successful, your login service makes a REST call to the <code>https://risk.sorbay.com/myriskservice/rest/loginok</code> location at the sorbay_risk service to signal that to the sorbay_risk service, with the same parameters as for the risk call further above. Only then does the sorbay_risk service store the attributes (partially hashed in special way with a secret for privacy reasons) in its database as the basis for future risk score evaluations.</p>
<h4 id="13-ok">13. ðŸ ˜ ok</h4>
<p>The sorbay_risk service confirms that it successfully recorded the login as successful.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Configuration" class="md-footer__link md-footer__link--prev" href="../sorbay_risk/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Configuration
            </div>
</div>
</a>
<a aria-label="Next: API" class="md-footer__link md-footer__link--next" href="../sorbay_risk_api/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              API
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
</body>
</html>